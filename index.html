<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- Tailwind CSS (스타일링) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (차트) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV 파싱) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; background-color: #f3f4f6; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 헤더 -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">우리 동네 아파트 실거래가 대시보드</h1>
                <p class="text-gray-500 mt-2 text-sm">구글 시트 데이터 연동 실시간 현황</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- 법정동 필터 드롭다운 (초기엔 숨김 처리) -->
                <select id="dong-filter" class="hidden bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 shadow-sm outline-none">
                    <option value="all">전체 법정동</option>
                </select>
                <div id="loading" class="flex items-center space-x-2 text-blue-600 font-medium">
                    <div class="spinner"></div>
                    <span id="loading-text">데이터를 불러오는 중...</span>
                </div>
            </div>
        </header>

        <!-- 요약 지표 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="summary-cards" style="display: none;">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="text-sm font-medium text-gray-500 mb-1">전체 거래 건수</div>
                <div class="text-2xl font-bold text-gray-900" id="val-count">0<span class="text-base font-normal text-gray-500 ml-1">건</span></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="text-sm font-medium text-gray-500 mb-1">평균 거래가격</div>
                <div class="text-2xl font-bold text-blue-600" id="val-avg">0<span class="text-base font-normal text-gray-500 ml-1">만원</span></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="text-sm font-medium text-gray-500 mb-1">최고 거래가격</div>
                <div class="text-2xl font-bold text-red-500" id="val-max">0<span class="text-base font-normal text-gray-500 ml-1">만원</span></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="text-sm font-medium text-gray-500 mb-1">최저 거래가격</div>
                <div class="text-2xl font-bold text-green-500" id="val-min">0<span class="text-base font-normal text-gray-500 ml-1">만원</span></div>
            </div>
        </div>

        <!-- 메인 콘텐츠 영역 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" id="main-content" style="display: none;">
            
            <!-- 차트 영역 -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-gray-800 mb-4">월별 평균 거래가격 추이</h2>
                <div class="relative h-80 w-full">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- 데이터 테이블 영역 -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 mt-4 lg:mt-0">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-lg font-bold text-gray-800">최근 거래 목록</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">거래일자</th>
                                <th scope="col" class="px-6 py-3">아파트명</th>
                                <th scope="col" class="px-6 py-3">법정동</th>
                                <th scope="col" class="px-6 py-3">전용면적(㎡)</th>
                                <th scope="col" class="px-6 py-3">층</th>
                                <th scope="col" class="px-6 py-3 text-right">거래금액(만원)</th>
                                <th scope="col" class="px-6 py-3 text-center">건축년도</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsQTSvBoCtdX7h6nfa4_JCGgwFom5lC4g2xXJWovyuffM6zFOfgQOpjKvNcK_tEmMyNS8CzPRkWdQ4/pub?gid=1375322304&single=true&output=csv';

        // 전역 상태 변수
        let globalRawData = []; 
        let priceChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // 1. 데이터 가져오기 및 파싱
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('네트워크 응답이 정상이 아닙니다.');
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        globalRawData = results.data;
                        
                        if (globalRawData.length === 0) {
                            document.getElementById('loading').innerHTML = '<span class="text-red-500">데이터가 없습니다.</span>';
                            return;
                        }

                        initFilter(globalRawData);
                        updateDashboard(globalRawData);

                        // 로딩 숨기고 화면 표시 및 필터 활성화
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dong-filter').classList.remove('hidden');
                        document.getElementById('summary-cards').style.display = 'grid';
                        document.getElementById('main-content').style.display = 'grid';
                    },
                    error: function(error) {
                        console.error('CSV 파싱 에러:', error);
                        alert('데이터 파싱 중 오류가 발생했습니다.');
                    }
                });
            } catch (error) {
                console.error('데이터 Fetch 에러:', error);
                document.getElementById('loading').innerHTML = '<span class="text-red-500">데이터를 불러오는데 실패했습니다. URL을 확인해주세요.</span>';
            }
        }

        // 2. 법정동 필터 초기화 및 이벤트 등록
        function initFilter(data) {
            const dongSet = new Set();
            
            data.forEach(row => {
                const keys = Object.keys(row);
                const dong = row['법정동'] || row[keys.find(k => k.includes('법정동'))];
                if (dong && dong.trim() !== '') {
                    dongSet.add(dong.trim());
                }
            });

            const select = document.getElementById('dong-filter');
            // 가나다 순으로 정렬하여 옵션 추가
            Array.from(dongSet).sort().forEach(dong => {
                const option = document.createElement('option');
                option.value = dong;
                option.textContent = dong;
                select.appendChild(option);
            });

            // 필터 변경 이벤트 처리
            select.addEventListener('change', (e) => {
                const selectedDong = e.target.value;
                if (selectedDong === 'all') {
                    updateDashboard(globalRawData);
                } else {
                    const filteredData = globalRawData.filter(row => {
                        const keys = Object.keys(row);
                        const dong = row['법정동'] || row[keys.find(k => k.includes('법정동'))];
                        return dong && dong.trim() === selectedDong;
                    });
                    updateDashboard(filteredData);
                }
            });
        }

        // 3. 대시보드 데이터 가공 및 전체 UI 업데이트 로직
        function updateDashboard(data) {
            let totalCount = 0;
            let sumPrice = 0;
            let maxPrice = -Infinity;
            let minPrice = Infinity;

            const monthlyData = {};
            const cleanData = [];

            data.forEach(row => {
                const keys = Object.keys(row);
                const getDate = () => row['거래일자'] || row[keys.find(k => k.includes('거래일자'))];
                const getName = () => row['아파트명'] || row[keys.find(k => k.includes('아파트명'))];
                const getDong = () => row['법정동'] || row[keys.find(k => k.includes('법정동'))];
                const getArea = () => row['전용면적(㎡)'] || row[keys.find(k => k.includes('전용면적'))];
                const getFloor = () => row['층'] || row[keys.find(k => k.includes('층'))];
                const getPrice = () => row['거래금액(만원)'] || row[keys.find(k => k.includes('거래금액'))];
                const getYear = () => row['건축년도'] || row[keys.find(k => k.includes('건축년도'))];

                const dateStr = getDate();
                const priceStr = getPrice();

                if (!dateStr || !priceStr) return; 

                const price = parseInt(priceStr.toString().replace(/,/g, ''), 10);
                if (isNaN(price)) return;

                totalCount++;
                sumPrice += price;
                if (price > maxPrice) maxPrice = price;
                if (price < minPrice) minPrice = price;

                const rawDate = dateStr.replace(/[^0-9]/g, ''); 
                let yearMonth = 'Unknown';
                if (rawDate.length >= 6) {
                    yearMonth = rawDate.substring(0, 4) + '-' + rawDate.substring(4, 6);
                }

                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = { sum: 0, count: 0 };
                }
                monthlyData[yearMonth].sum += price;
                monthlyData[yearMonth].count += 1;

                cleanData.push({
                    date: dateStr,
                    name: getName() || '-',
                    dong: getDong() || '-',
                    area: getArea() || '-',
                    floor: getFloor() || '-',
                    price: price,
                    year: getYear() || '-'
                });
            });

            // 필터 결과가 없을 경우 방어 로직
            const avgPrice = totalCount > 0 ? Math.round(sumPrice / totalCount) : 0;
            const finalMaxPrice = maxPrice !== -Infinity ? maxPrice : 0;
            const finalMinPrice = minPrice !== Infinity ? minPrice : 0;
            
            const fmt = (num) => new Intl.NumberFormat('ko-KR').format(num);

            // 요약 지표 업데이트
            document.getElementById('val-count').innerHTML = `${fmt(totalCount)}<span class="text-base font-normal text-gray-500 ml-1">건</span>`;
            document.getElementById('val-avg').innerHTML = `${fmt(avgPrice)}<span class="text-base font-normal text-gray-500 ml-1">만원</span>`;
            document.getElementById('val-max').innerHTML = `${fmt(finalMaxPrice)}<span class="text-base font-normal text-gray-500 ml-1">만원</span>`;
            document.getElementById('val-min').innerHTML = `${fmt(finalMinPrice)}<span class="text-base font-normal text-gray-500 ml-1">만원</span>`;

            renderChart(monthlyData);
            renderTable(cleanData);
        }

        // 4. 차트 렌더링 (인스턴스 파괴 로직 추가)
        function renderChart(monthlyData) {
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths;
            const dataPoints = sortedMonths.map(month => {
                return Math.round(monthlyData[month].sum / monthlyData[month].count);
            });

            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // 기존 차트가 존재하면 파괴 (메모리 누수 및 차트 겹침 현상 방지)
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }

            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '평균 거래가격 (만원)',
                        data: dataPoints,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(59, 130, 246)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return new Intl.NumberFormat('ko-KR').format(context.parsed.y) + ' 만원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('ko-KR').format(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 5. 테이블 렌더링
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">해당 조건의 거래 내역이 없습니다.</td></tr>';
                return;
            }

            data.sort((a, b) => b.date.localeCompare(a.date));

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${row.date}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${row.name}</td>
                    <td class="px-6 py-4">${row.dong}</td>
                    <td class="px-6 py-4">${row.area}</td>
                    <td class="px-6 py-4">${row.floor}</td>
                    <td class="px-6 py-4 text-right font-medium text-blue-600">${new Intl.NumberFormat('ko-KR').format(row.price)}</td>
                    <td class="px-6 py-4 text-center">${row.year}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
